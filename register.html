<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>카드 등록</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='./style.css')}}" >
  </head>
  <body class="register-page">
    <h1>카드 등록하기</h1>
    <p>카드의 RFID ID와 사용자 정보를 입력하세요.</p>

    <div
      id="tagUI"
      style="display: none; margin: 15px 0; font-weight: bold; color: red"
    >
      카드를 리더기에 태그해주세요
    </div>
    <div id="tagResult"></div>

    <form>
      <div class="form-grid">
        <label
          >입원번호
          <input
            type="text"
            id="admissionId"
            placeholder="사용할 ID를 입력해주세요."
          />
        </label>
        <label
          >체중(kg)
          <input
            type="number"
            name="weight"
            required
            placeholder="체중을 입력해주세요."
          />
        </label>
        <label
          >이름
          <input
            type="text"
            name="name"
            required
            placeholder="이름을 입력해주세요."
          />
        </label>
        <label
          >질병(없으면 X)
          <input
            type="text"
            name="disease"
            value="x"
            placeholder="질병을 입력해주세요."
          />
        </label>
        <label
          >성별(0: 여자, 1: 남자)
          <input
            type="number"
            name="gender"
            min="0"
            max="1"
            required
            placeholder="성별을 입력해주세요."
          />
        </label>
        <label
          >감기여부(0: 아니오, 1: 예)
          <input
            type="number"
            name="cold"
            min="0"
            max="1"
            required
            placeholder="감기 여부를 입력해주세요."
          />
        </label>
        <label
          >나이(year)
          <input
            type="number"
            name="age"
            required
            placeholder="나이를 입력해주세요."
          />
        </label>
        <label
          >비밀번호
          <input
            type="number"
            name="password"
            required
            placeholder="비밀번호를 입력해주세요."
          />
        </label>
      </div>
      <div class="button-container">
        <button id="doneBtn" type="submit">등록하기</button>
      </div>
    </form>

    
    <a class="back-link" href="/">Go Back To Main Page</a>

    <script>
      document
        .getElementById('doneBtn')
        .addEventListener('click', function (e) {
          e.preventDefault();
          console.log('Register Process On Going');

          admission_id = document.getElementById('admissionId').value;
          console.log('admission_id is ' + admission_id);

          const form = document.querySelector('form');
          const formData = new FormData(form);

          let payload = {};
          formData.forEach((value, key) => {
            payload[key] = value;
          });

          payload['id'] = admission_id;
          if (payload.gender !== undefined)
            payload.gender = Number(payload.gender);
          if (payload.age !== undefined) payload.age = Number(payload.age);
          if (payload.weight !== undefined)
            payload.weight = Number(payload.weight);
          if (payload.cold !== undefined) payload.cold = Number(payload.cold);
          if (payload.password !== undefined)
            payload.password = Number(payload.password);
          payload.drank = 0;

          console.log('Payload:', payload);

          document.getElementById('tagUI').style.display = 'block';

          fetch('/write_route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data) {
                console.log(data);
                alert('Register is Successful, Go To MainPage');
                window.location.href = '/';
              }
            })
            .catch(() => {
              document.getElementById('tagResult').innerText =
                '서버 연결 오류 발생';
            });
        });
    </script>
  </body>
</html>