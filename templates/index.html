<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Smart Water Dispenser</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='./style.css')}}" >
    <style>
      body {
        text-align: center;
        font-size: 20px;
        font-family: Arial, sans-serif;
        margin-top: 50px;
      }

      #cardInfo {
        margin-top: 20px;
        font-size: 22px;
        white-space: pre-line;
        font-weight: bold;
        min-height: 80px;
      }

      #drink-btn {
        font-size: 18px;
        margin-top: 10px;
        display: none;
      }

      #tagCardBtn {
        font-size: 24px;
        padding: 10px 20px;
        cursor: pointer;
        margin: 20px auto;
        display: block;
      }

      .link-area {
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <h1>Smart Water Dispenser</h1>
    <p>카드 태그 전 버튼을 눌러주세요</p>
        <!-- 카드 태그하기 버튼을 아래로 -->
    <button id="tagCardBtn">카드 태그하기</button>


    <!-- 카드 정보 표시 영역 -->
    <div id="cardInfo"></div>
    <p id="drink-btn">if you want to drink, push drink btn</p>

    <!-- 링크 -->
    <div class="link-area">
      <a href="./register">카드 등록</a>
    </div>

    <script>
      let currentTagId = null;
      const tagBtn = document.getElementById('tagCardBtn');
      const out = document.getElementById('cardInfo');
      const drinkBtn = document.getElementById('drink-btn');

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

      tagBtn.addEventListener('click', async function () {
        if (tagBtn.disabled) return;
        tagBtn.disabled = true;

        out.innerText = '카드를 태그하세요...';
        tagBtn.textContent = '태그 대기중...';

        try {
          const timeoutMs = 15000;
          const intervalMs = 500;
          const deadline = Date.now() + timeoutMs;

          let des1 = null;
          while (Date.now() < deadline) {
            const res1 = await fetch('/read_route');
            des1 = await res1.json();
            if (des1 && des1.tag_id) break;
            await sleep(intervalMs);
          }

          if (!des1 || !des1.tag_id) {
            out.innerText = '태그가 감지되지 않았습니다. 다시 시도해주세요.';
            return;
          }

          currentTagId = des1.tag_id;

          const res2 = await fetch('/calc_route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tag_id: des1.tag_id }),
          });
          const info = await res2.json();

          if (!info.ok) {
            out.innerText = `오류: ${info.error || 'unknown'}`;
            return;
          }

          out.innerText = `${info.person.name} / 권장: ${info.recommended_water}ml / 오늘섭취: ${info.today_drank_ml}ml`;
          drinkBtn.style.display = 'block';
        } catch (e) {
          out.innerText = '서버 오류 발생';
          console.error(e);
        } finally {
          tagBtn.disabled = false;
          tagBtn.textContent = '카드 태그하기';
        }
      });

      setInterval(async () => {
        if (!currentTagId) return;
        try {
          const res = await fetch(`/status?tag_id=${currentTagId}`);
          const data = await res.json();
          if (data.ok) {
            const text = out.innerText;
            out.innerText = text.replace(
              /오늘섭취: \d+ml/,
              `오늘섭취: ${data.today_drank_ml}ml`
            );
          }
        } catch (e) {
          console.error('polling error', e);
        }
      }, 3000);
    </script>
  </body>
</html>